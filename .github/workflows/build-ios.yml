name: Build iOS IPA with Yandex & VK Ads

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      run: |
        echo "üîß Setting up Xcode..."
        xcodebuild -version
        swift --version
        echo "‚úÖ Xcode ready"

    - name: Download Godot
      run: |
        echo "üì• Downloading Godot 4.4.1..."
        wget -q https://github.com/godotengine/godot/releases/download/4.4.1-stable/Godot_v4.4.1-stable_macos.universal.zip
        unzip -q Godot_v4.4.1-stable_macos.universal.zip
        mkdir -p ~/bin
        mv Godot.app ~/bin/
        echo "$HOME/bin/Godot.app/Contents/MacOS" >> $GITHUB_PATH
        echo "‚úÖ Godot installed"

    - name: Download Export Templates
      run: |
        echo "üì• Downloading export templates..."
        wget -q https://github.com/godotengine/godot/releases/download/4.4.1-stable/Godot_v4.4.1-stable_export_templates.tpz
        mkdir -p ~/Library/Application\ Support/Godot/export_templates/4.4.1.stable/
        unzip -q Godot_v4.4.1-stable_export_templates.tpz
        mv templates/* ~/Library/Application\ Support/Godot/export_templates/4.4.1.stable/
        echo "‚úÖ Export templates installed"

    - name: Download Yandex Mobile Ads XCFramework
      run: |
        echo "üì• Downloading Yandex Mobile Ads XCFramework..."
        
        # Download to plugin directory BEFORE Godot export
        mkdir -p ios/plugins/yandex_ads
        cd ios/plugins/yandex_ads
        
        # Download official Yandex Mobile Ads 7.17.1 XCFramework from S3
        wget -q https://ads-mobile-sdk.s3.yandex.net/Yandex/YandexMobileAds/7.17.1/spm/5177c6a0-8b16-4da1-8d24-8cb968316b04.zip -O YandexMobileAds.zip
        unzip -q YandexMobileAds.zip
        rm YandexMobileAds.zip
        
        echo "‚úÖ Yandex XCFramework downloaded to plugin directory"
        ls -la

    - name: Compile iOS Plugins
      run: |
        echo "üî® Compiling iOS plugins (.mm to .a)..."
        
        # Compile Yandex plugin
        cd ios/plugins/yandex_ads
        echo "üìù Compiling yandex_ads.mm..."
        
        # Find XCFramework and show structure
        echo "üìÇ Looking for XCFramework..."
        find . -name "*.xcframework" -type d
        
        FRAMEWORK_PATH=$(find . -name "YandexMobileAds.xcframework" -type d | head -1)
        echo "üìÇ Framework path: $FRAMEWORK_PATH"
        
        if [ -d "$FRAMEWORK_PATH" ]; then
          echo "üìÇ XCFramework structure:"
          ls -la "$FRAMEWORK_PATH"
          
          # Find the correct architecture folder
          if [ -d "$FRAMEWORK_PATH/ios-arm64" ]; then
            HEADERS_PATH="$FRAMEWORK_PATH/ios-arm64/YandexMobileAds.framework/Headers"
          elif [ -d "$FRAMEWORK_PATH/ios-arm64_armv7" ]; then
            HEADERS_PATH="$FRAMEWORK_PATH/ios-arm64_armv7/YandexMobileAds.framework/Headers"
          else
            # List all folders to find correct one
            echo "üìÇ Available architectures:"
            ls -la "$FRAMEWORK_PATH/"
            HEADERS_PATH=$(find "$FRAMEWORK_PATH" -name "Headers" -type d | head -1)
          fi
          
          echo "üìÇ Headers path: $HEADERS_PATH"
          ls -la "$HEADERS_PATH" || echo "‚ùå Headers not found"
          
          # Get framework directory (parent of Headers)
          FRAMEWORK_DIR=$(dirname "$HEADERS_PATH")
          XCFRAMEWORK_DIR=$(dirname "$(dirname "$FRAMEWORK_DIR")")
          
          echo "üìÇ Framework dir: $FRAMEWORK_DIR"
          echo "üìÇ XCFramework dir: $XCFRAMEWORK_DIR"
          
          xcrun clang -x objective-c++ \
            -arch arm64 \
            -isysroot /Applications/Xcode_15.4.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS17.5.sdk \
            -mios-version-min=13.0 \
            -F"$XCFRAMEWORK_DIR" \
            -c yandex_ads.mm -o yandex_ads.o
          
          # Create static library
          ar rcs yandex_ads.a yandex_ads.o
          
          echo "‚úÖ yandex_ads.a created"
          ls -la yandex_ads.a
        else
          echo "‚ùå XCFramework not found!"
          exit 1
        fi
        
        # Compile VK plugin
        cd ../vk_ads
        echo "üìù Compiling vk_ads.mm..."
        
        xcrun clang -x objective-c++ \
          -arch arm64 \
          -isysroot /Applications/Xcode_15.4.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS17.5.sdk \
          -mios-version-min=13.0 \
          -c vk_ads.mm -o vk_ads.o
        
        ar rcs vk_ads.a vk_ads.o
        
        echo "‚úÖ vk_ads.a created"
        ls -la vk_ads.a

    - name: Install CocoaPods
      run: |
        echo "üì¶ Installing CocoaPods..."
        sudo gem install cocoapods -v 1.15.2
        pod --version
        echo "‚úÖ CocoaPods installed"

    - name: Export iOS Xcode Project
      run: |
        echo "üî® Exporting iOS Xcode project..."
        mkdir -p build
        ~/bin/Godot.app/Contents/MacOS/Godot --headless --export-debug "iOS" build/ios_xcode
        echo "‚úÖ Xcode project exported"

    - name: List exported files
      run: |
        echo "üìÇ Checking exported files..."
        ls -la build/
        if [ -d "build/ios_xcode" ]; then
          ls -la build/ios_xcode/
        fi

    - name: Find Xcode Project
      run: |
        echo "üîç Searching for Xcode project..."
        find build -name "*.xcodeproj" -type d
        
        # Find the actual xcodeproj
        XCODE_PROJ=$(find build -name "*.xcodeproj" -type d | head -1)
        if [ -z "$XCODE_PROJ" ]; then
          echo "‚ùå No .xcodeproj found!"
          exit 1
        fi
        
        echo "‚úÖ Found: $XCODE_PROJ"
        echo "XCODE_PROJECT_PATH=$XCODE_PROJ" >> $GITHUB_ENV
        echo "XCODE_PROJECT_DIR=$(dirname $XCODE_PROJ)" >> $GITHUB_ENV

    - name: Install CocoaPods Dependencies
      run: |
        echo "üì¶ Installing Pods (VK SDK)..."
        cd "$XCODE_PROJECT_DIR"
        
        # Copy Podfile
        cp ../ios/Podfile .
        
        # Get project name
        PROJ_NAME=$(basename "$XCODE_PROJECT_PATH" .xcodeproj)
        echo "üìù Project name: $PROJ_NAME"
        
        # Update Podfile with correct project name
        sed -i '' "s/TestAdMobApp/$PROJ_NAME/g" Podfile
        
        # Install pods (only VK SDK now)
        pod install --repo-update
        echo "‚úÖ Pods installed"

    - name: Build IPA (unsigned)
      run: |
        echo "üî® Building unsigned IPA..."
        cd "$XCODE_PROJECT_DIR"
        
        PROJ_NAME=$(basename "$XCODE_PROJECT_PATH" .xcodeproj)
        
        # After pod install, MUST use workspace
        if [ -d "Pods/${PROJ_NAME}.xcworkspace" ]; then
          BUILD_TARGET="-workspace Pods/${PROJ_NAME}.xcworkspace"
          echo "‚úÖ Using workspace from Pods"
        elif [ -d "${PROJ_NAME}.xcworkspace" ]; then
          BUILD_TARGET="-workspace ${PROJ_NAME}.xcworkspace"
          echo "‚úÖ Using workspace"
        else
          BUILD_TARGET="-project ${PROJ_NAME}.xcodeproj"
          echo "‚ö†Ô∏è Using project (no workspace found)"
        fi
        
        echo "üìù Build target: $BUILD_TARGET"
        echo "üìù Scheme: $PROJ_NAME"
        
        # Build without code signing (Yandex XCFramework embedded by Godot)
        xcodebuild $BUILD_TARGET \
          -scheme $PROJ_NAME \
          -configuration Release \
          -sdk iphoneos \
          -derivedDataPath DerivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          ONLY_ACTIVE_ARCH=NO \
          build
        
        echo "‚úÖ Build completed"

    - name: Create IPA
      run: |
        echo "üì¶ Creating IPA package..."
        cd "$XCODE_PROJECT_DIR"
        
        PROJ_NAME=$(basename "$XCODE_PROJECT_PATH" .xcodeproj)
        
        # Create Payload directory
        mkdir -p Payload
        
        # Copy .app to Payload
        APP_PATH="DerivedData/Build/Products/Release-iphoneos/${PROJ_NAME}.app"
        if [ -d "$APP_PATH" ]; then
          cp -r "$APP_PATH" Payload/
          echo "‚úÖ App copied to Payload"
        else
          echo "‚ùå App not found at $APP_PATH"
          echo "üìÇ Searching for .app..."
          find DerivedData -name "*.app" -type d
          exit 1
        fi
        
        # Create IPA
        zip -r TestAdMobApp.ipa Payload
        echo "‚úÖ IPA created"
        
        # Show IPA size
        ls -lh TestAdMobApp.ipa

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: TestAdMobApp-iOS
        path: ${{ env.XCODE_PROJECT_DIR }}/TestAdMobApp.ipa
        if-no-files-found: error

    - name: Build Summary
      if: success()
      run: |
        echo "üéâ Build successful!"
        echo "üì± Download IPA from Artifacts"
        echo "üîß Install via Sideloadly"
        echo ""
        echo "‚úÖ Included SDKs:"
        echo "  - Yandex Mobile Ads"
        echo "  - VK Ads (MyTarget)"
        echo "  - AdMob"
