name: Build iOS IPA (Clean - No Ads)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      run: |
        echo "üîß Xcode version:"
        xcodebuild -version
        swift --version

    - name: Download Godot
      run: |
        echo "üì• Downloading Godot 4.4.1..."
        wget -q https://github.com/godotengine/godot/releases/download/4.4.1-stable/Godot_v4.4.1-stable_macos.universal.zip
        unzip -q Godot_v4.4.1-stable_macos.universal.zip
        mkdir -p ~/bin
        mv Godot.app ~/bin/
        echo "$HOME/bin/Godot.app/Contents/MacOS" >> $GITHUB_PATH
        echo "‚úÖ Godot installed"

    - name: Download Export Templates
      run: |
        echo "üì• Downloading export templates..."
        wget -q https://github.com/godotengine/godot/releases/download/4.4.1-stable/Godot_v4.4.1-stable_export_templates.tpz
        mkdir -p ~/Library/Application\ Support/Godot/export_templates/4.4.1.stable/
        unzip -q Godot_v4.4.1-stable_export_templates.tpz
        mv templates/* ~/Library/Application\ Support/Godot/export_templates/4.4.1.stable/
        echo "‚úÖ Export templates installed"

    - name: Export iOS Xcode Project
      run: |
        echo "üî® Exporting iOS Xcode project..."
        mkdir -p build
        ~/bin/Godot.app/Contents/MacOS/Godot --headless --export-debug "iOS" build/ios_xcode
        echo "‚úÖ Xcode project exported"

    - name: Find Xcode Project
      run: |
        echo "üîç Finding Xcode project..."
        XCODE_PROJ=$(find build -name "*.xcodeproj" -type d | head -1)
        if [ -z "$XCODE_PROJ" ]; then
          echo "‚ùå No .xcodeproj found!"
          exit 1
        fi
        
        echo "‚úÖ Found: $XCODE_PROJ"
        echo "XCODE_PROJECT_PATH=$XCODE_PROJ" >> $GITHUB_ENV
        echo "XCODE_PROJECT_DIR=$(dirname $XCODE_PROJ)" >> $GITHUB_ENV

    - name: Build IPA (unsigned)
      run: |
        echo "üî® Building unsigned IPA..."
        cd "$XCODE_PROJECT_DIR"
        
        PROJ_NAME=$(basename "$XCODE_PROJECT_PATH" .xcodeproj)
        echo "üìù Project: $PROJ_NAME"
        
        # Build without code signing
        xcodebuild -project "$XCODE_PROJECT_PATH" \
          -scheme "$PROJ_NAME" \
          -configuration Release \
          -sdk iphoneos \
          -derivedDataPath DerivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          ONLY_ACTIVE_ARCH=NO \
          build
        
        echo "‚úÖ Build completed"

    - name: Create IPA
      run: |
        echo "üì¶ Creating IPA..."
        cd "$XCODE_PROJECT_DIR"
        
        PROJ_NAME=$(basename "$XCODE_PROJECT_PATH" .xcodeproj)
        APP_PATH="DerivedData/Build/Products/Release-iphoneos/${PROJ_NAME}.app"
        
        if [ ! -d "$APP_PATH" ]; then
          echo "‚ùå App not found at $APP_PATH"
          exit 1
        fi
        
        # Create Payload
        mkdir -p Payload
        cp -r "$APP_PATH" Payload/
        
        # Create IPA
        zip -r TestAdMobApp.ipa Payload
        
        echo "‚úÖ IPA created"
        ls -lh TestAdMobApp.ipa

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: TestAdMobApp-iOS-Clean
        path: ${{ env.XCODE_PROJECT_DIR }}/TestAdMobApp.ipa
        if-no-files-found: error

    - name: Build Summary
      if: success()
      run: |
        echo "üéâ Clean iOS build successful!"
        echo "üì± No ads included (plugins disabled)"
        echo "üîß Install via Sideloadly or 3uTools"
