name: Build iOS IPA with Yandex & VK Ads

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      run: |
        echo "üîß Setting up Xcode..."
        xcodebuild -version
        swift --version
        echo "‚úÖ Xcode ready"

    - name: Download Godot
      run: |
        echo "üì• Downloading Godot 4.4.1..."
        wget -q https://github.com/godotengine/godot/releases/download/4.4.1-stable/Godot_v4.4.1-stable_macos.universal.zip
        unzip -q Godot_v4.4.1-stable_macos.universal.zip
        mkdir -p ~/bin
        mv Godot.app ~/bin/
        echo "$HOME/bin/Godot.app/Contents/MacOS" >> $GITHUB_PATH
        echo "‚úÖ Godot installed"

    - name: Download Export Templates
      run: |
        echo "üì• Downloading export templates..."
        wget -q https://github.com/godotengine/godot/releases/download/4.4.1-stable/Godot_v4.4.1-stable_export_templates.tpz
        mkdir -p ~/Library/Application\ Support/Godot/export_templates/4.4.1.stable/
        unzip -q Godot_v4.4.1-stable_export_templates.tpz
        mv templates/* ~/Library/Application\ Support/Godot/export_templates/4.4.1.stable/
        echo "‚úÖ Export templates installed"

    - name: Skip Manual SDK Download (CocoaPods will handle it)
      run: |
        echo "üìù Yandex SDK will be installed via CocoaPods after Godot export"
        echo "‚úÖ Skipping manual download"

    - name: Compile iOS Plugins
      run: |
        echo "üî® Compiling iOS plugins..."
        cd ios
        
        # Make script executable
        chmod +x build_plugins.sh
        
        # Run compilation
        ./build_plugins.sh
        
        echo "‚úÖ Plugins compiled"
        
        # Verify xcframeworks were created
        if [ -d "plugins/yandex_ads/yandex_ads.xcframework" ]; then
          echo "‚úÖ yandex_ads.xcframework created"
          ls -la plugins/yandex_ads/yandex_ads.xcframework
        else
          echo "‚ùå yandex_ads.xcframework NOT created"
          exit 1
        fi

    - name: Install CocoaPods
      run: |
        echo "üì¶ Installing CocoaPods..."
        sudo gem install cocoapods -v 1.15.2
        pod --version
        echo "‚úÖ CocoaPods installed"

    - name: Export iOS Xcode Project
      run: |
        echo "üî® Exporting iOS Xcode project..."
        mkdir -p build
        ~/bin/Godot.app/Contents/MacOS/Godot --headless --export-debug "iOS" build/ios_xcode
        echo "‚úÖ Xcode project exported"

    - name: List exported files
      run: |
        echo "üìÇ Checking exported files..."
        ls -la build/
        if [ -d "build/ios_xcode" ]; then
          ls -la build/ios_xcode/
        fi

    - name: Find Xcode Project
      run: |
        echo "üîç Searching for Xcode project..."
        find build -name "*.xcodeproj" -type d
        
        # Find the actual xcodeproj
        XCODE_PROJ=$(find build -name "*.xcodeproj" -type d | head -1)
        if [ -z "$XCODE_PROJ" ]; then
          echo "‚ùå No .xcodeproj found!"
          exit 1
        fi
        
        echo "‚úÖ Found: $XCODE_PROJ"
        echo "XCODE_PROJECT_PATH=$XCODE_PROJ" >> $GITHUB_ENV
        echo "XCODE_PROJECT_DIR=$(dirname $XCODE_PROJ)" >> $GITHUB_ENV

    - name: Patch dummy.cpp for extern C
      run: |
        echo "üîß Patching dummy.cpp to add extern C declarations..."
        cd "$XCODE_PROJECT_DIR"
        
        # Find dummy.cpp
        DUMMY_FILE=$(find . -name "dummy.cpp" -o -name "*dummy*.cpp" -o -name "godot_plugin*.cpp" | head -1)
        
        if [ -z "$DUMMY_FILE" ]; then
          echo "‚ö†Ô∏è  dummy.cpp not found, searching..."
          DUMMY_FILE=$(find . -type f -name "*.cpp" | xargs grep -l "godot_ios_plugins_initialize" | head -1)
        fi
        
        if [ -n "$DUMMY_FILE" ]; then
          echo "üìù Found: $DUMMY_FILE"
          echo "üìÑ Original content around godot_ios_plugins_initialize:"
          grep -B 2 -A 2 "void godot_ios_plugins_initialize()" "$DUMMY_FILE" || true
          
          # Insert extern C declarations at the top of file (after includes)
          # Find first function and insert before it
          awk '/^void godot_ios_plugins_initialize\(\)/ {
            print "// Extern C declarations for iOS plugins"
            print "extern \"C\" void yandex_ads_init();"
            print "extern \"C\" void yandex_ads_deinit();"
            print ""
          }
          {print}' "$DUMMY_FILE" > "$DUMMY_FILE.tmp"
          
          mv "$DUMMY_FILE.tmp" "$DUMMY_FILE"
          
          echo "‚úÖ Patched $DUMMY_FILE"
          echo "üìÑ Patched content:"
          grep -B 1 -A 5 "extern \"C\" void yandex" "$DUMMY_FILE" || true
        else
          echo "‚ùå Could not find dummy.cpp!"
          find . -name "*.cpp" -type f
          exit 1
        fi

    - name: Install CocoaPods Dependencies
      run: |
        echo "üì¶ Installing Pods (Yandex + VK SDK)..."
        cd "$XCODE_PROJECT_DIR"
        
        # Get project name
        PROJ_NAME=$(basename "$XCODE_PROJECT_PATH" .xcodeproj)
        echo "üìù Project name: $PROJ_NAME"
        
        # Copy Podfile template from workspace root
        WORKSPACE_ROOT="${GITHUB_WORKSPACE}"
        echo "üìÇ Workspace root: $WORKSPACE_ROOT"
        
        if [ ! -f "$WORKSPACE_ROOT/ios/Podfile.template" ]; then
          echo "‚ùå Podfile.template not found at $WORKSPACE_ROOT/ios/Podfile.template"
          ls -la "$WORKSPACE_ROOT/ios/"
          exit 1
        fi
        
        cp "$WORKSPACE_ROOT/ios/Podfile.template" ./Podfile
        sed -i '' "s/PROJECT_NAME_PLACEHOLDER/$PROJ_NAME/g" Podfile
        
        echo "üìÑ Podfile content:"
        cat Podfile
        
        # Install pods (Yandex + VK SDK with Swift support)
        pod install --repo-update
        
        echo "‚úÖ Pods installed"
        echo "üìÇ Workspace created:"
        ls -la *.xcworkspace

    - name: Build IPA (unsigned)
      run: |
        echo "üî® Building unsigned IPA..."
        cd "$XCODE_PROJECT_DIR"
        
        PROJ_NAME=$(basename "$XCODE_PROJECT_PATH" .xcodeproj)
        
        # After pod install, MUST use workspace (CocoaPods creates it)
        WORKSPACE="${PROJ_NAME}.xcworkspace"
        
        if [ ! -d "$WORKSPACE" ]; then
          echo "‚ùå Workspace not found: $WORKSPACE"
          echo "üìÇ Available files:"
          ls -la
          exit 1
        fi
        
        echo "‚úÖ Using workspace: $WORKSPACE"
        echo "üìù Scheme: $PROJ_NAME"
        
        # Build without code signing
        # CocoaPods automatically handles Swift libraries!
        xcodebuild -workspace "$WORKSPACE" \
          -scheme "$PROJ_NAME" \
          -configuration Release \
          -sdk iphoneos \
          -derivedDataPath DerivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          ONLY_ACTIVE_ARCH=NO \
          build
        
        echo "‚úÖ Build completed"

    - name: Copy Swift Libraries
      run: |
        echo "üìö Copying Swift standard libraries..."
        cd "$XCODE_PROJECT_DIR"
        
        PROJ_NAME=$(basename "$XCODE_PROJECT_PATH" .xcodeproj)
        APP_PATH="DerivedData/Build/Products/Release-iphoneos/${PROJ_NAME}.app"
        
        if [ ! -d "$APP_PATH" ]; then
          echo "‚ùå App not found at $APP_PATH"
          exit 1
        fi
        
        # Create Frameworks directory in app
        mkdir -p "$APP_PATH/Frameworks"
        
        # Find Swift libraries - try multiple locations
        SWIFT_LIBS=""
        for path in \
          "/Applications/Xcode_15.4.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift-5.0/iphoneos" \
          "/Applications/Xcode_15.4.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/iphoneos" \
          "$(xcode-select -p)/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift-5.0/iphoneos" \
          "$(xcode-select -p)/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/iphoneos"; do
          if [ -d "$path" ] && [ -f "$path/libswiftCore.dylib" ]; then
            SWIFT_LIBS="$path"
            break
          fi
        done
        
        if [ -z "$SWIFT_LIBS" ]; then
          echo "‚ùå Swift libraries not found, searching..."
          find /Applications/Xcode_15.4.app -name "libswiftCore.dylib" 2>/dev/null | head -5
          exit 1
        fi
        
        echo "üìÇ Swift libraries path: $SWIFT_LIBS"
        
        # Copy required Swift libraries
        echo "üìã Copying Swift runtime libraries..."
        for lib in libswiftCore.dylib libswiftFoundation.dylib libswiftUIKit.dylib \
                   libswiftCoreGraphics.dylib libswiftDispatch.dylib libswiftObjectiveC.dylib \
                   libswift_Concurrency.dylib libswiftCoreFoundation.dylib libswiftDarwin.dylib \
                   libswiftCompatibility50.dylib libswiftCompatibility51.dylib \
                   libswiftCompatibilityDynamicReplacements.dylib; do
          if [ -f "$SWIFT_LIBS/$lib" ]; then
            cp "$SWIFT_LIBS/$lib" "$APP_PATH/Frameworks/"
            echo "  ‚úÖ Copied $lib"
          fi
        done
        
        echo "‚úÖ Swift libraries copied"
        echo "üìÇ Frameworks directory:"
        ls -lh "$APP_PATH/Frameworks/"

    - name: Create IPA
      run: |
        echo "üì¶ Creating IPA package..."
        cd "$XCODE_PROJECT_DIR"
        
        PROJ_NAME=$(basename "$XCODE_PROJECT_PATH" .xcodeproj)
        
        # Create Payload directory
        mkdir -p Payload
        
        # Copy .app to Payload
        APP_PATH="DerivedData/Build/Products/Release-iphoneos/${PROJ_NAME}.app"
        if [ -d "$APP_PATH" ]; then
          cp -r "$APP_PATH" Payload/
          echo "‚úÖ App copied to Payload"
        else
          echo "‚ùå App not found at $APP_PATH"
          echo "üìÇ Searching for .app..."
          find DerivedData -name "*.app" -type d
          exit 1
        fi
        
        # Create IPA
        zip -r TestAdMobApp.ipa Payload
        echo "‚úÖ IPA created"
        
        # Show IPA size
        ls -lh TestAdMobApp.ipa

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: TestAdMobApp-iOS
        path: ${{ env.XCODE_PROJECT_DIR }}/TestAdMobApp.ipa
        if-no-files-found: error

    - name: Build Summary
      if: success()
      run: |
        echo "üéâ Build successful!"
        echo "üì± Download IPA from Artifacts"
        echo "üîß Install via Sideloadly"
        echo ""
        echo "‚úÖ Included SDKs:"
        echo "  - Yandex Mobile Ads"
        echo "  - VK Ads (MyTarget)"
        echo "  - AdMob"
